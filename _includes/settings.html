<form class="group" data-controller="settings" data-action="submit->settings#submit" data-settings-loading-value="false" novalidate>
    {% capture content %}
    <script type="module">
        import { Controller } from "./assets/javascript/lib/stimulus.js"
        Stimulus.register("settings", class extends Controller {
            static targets = [ "results", "email", "password", "submitButton", "error" ]
            static values = {
                loading: Boolean
            }

            connect() {
                console.log("sign in");
            }

            async submit(event) {
                event.preventDefault()
                this.submitButtonTarget.disabled = true
                this.loadingValue = true
                this.errorTarget.textContent = ""
                console.log(this.submitButtonTarget);

                let authorization = `${this.emailTarget.value}:${this.passwordTarget.value}`
                authorization = window.btoa(unescape(encodeURIComponent(authorization)))

                const url = "{{ site.urls.authentication | build_url }}";
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Authorization": `Basic ${authorization}`,
                            "Content-Type": "application/json"
                        }
                    });

                    if (!response.ok) {
                        const error = new Error(`Invalid response`)
                        error.response = response
                        throw error;
                    }

                    const data = await response.json();

                    this.resultsTarget.textContent = data.page_token
                } catch (error) {
                    if ("response" in error && error.response.status == 401) {
                        this.errorTarget.textContent = "Invalid email or password."
                    } else {
                        this.errorTarget.textContent = `Invalid response: ${error.response.statusText}`
                    }
                    console.error("Request failed:", error);
                }

                this.submitButtonTarget.disabled = false
                this.loadingValue = false

            }
        })
        </script>
        <div class="settings">
            <div class="flex flex-col gap-4 items-stretch">
                <div data-settings-target="error" class="bg-red-200 p-2 rounded text-red-600 mb-2 text-sm empty:hidden"></div>
                <input
                    class="text-input"
                    type="text"
                    name="email"
                    data-settings-target="email"
                    placeholder="Email Address"
                    autocorrect="off"
                    autocapitalize="off"
                    spellcheck="false"
                    required
                />
                <input
                    class="text-input"
                    type="password"
                    name="password"
                    data-settings-target="password"
                    placeholder="Password"
                />
            </div>

            <span data-settings-target="results"></span>
        </div>
    {% endcapture %}
    {% capture button %}
        <button data-settings-target="submitButton" type="submit" class="primary-button">
            <span class="hidden group-data-[settings-loading-value=false]:block">
                Sign In
            </span>
            <span class="hidden group-data-[settings-loading-value=true]:block">
                Loadingâ€¦
            </span>
        </button>
    {% endcapture %}
    {% include shared/tab.html content=content button=button %}
</form>
