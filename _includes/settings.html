<form class="group" data-controller="settings" data-action="submit->settings#submit" data-settings-loading-value="false" novalidate>
    {% capture content %}
    <script type="module">
        import { Controller } from "./assets/javascript/lib/stimulus.js"
        Stimulus.register("settings", class extends Controller {
            static targets = [ "results", "form", "email", "password", "submitButton", "error" ]
            static values = {
                loading: Boolean
            }

            connect() {
                console.log("sign in");
            }

            async submit(event) {
                event.preventDefault()
                this.submitButtonTarget.disabled = true
                this.loadingValue = true
                this.errorTarget.textContent = ""
                console.log(this.submitButtonTarget);

                const formData = new FormData(this.formTarget);
                let data = new URLSearchParams(formData).toString()
                console.log(data)


                console.log(this.emailValue);
                console.log(this.passwordValue);

                const credentials = btoa(`${username}:${password}`); // Base64 encode
                const url = "{{ site.urls.authentication | build_url }}";


                try {
                    const response = await fetch('https://example.com/protected-endpoint', {
                        method: 'GET', // or 'POST', depending on your API
                        headers: {
                            'Authorization': `Basic ${credentials}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Success:', data);
                } catch (error) {
                    console.error('Request failed:', error);
                }


                const url = "{{site.api_host}}/extension/authentication.json";
                try {
                  const response = await fetch(url);
                  if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                  }

                  const json = await response.json();
                  this.resultsTarget.textContent = json.amount
                  console.log(json);
                } catch (error) {
                  console.error(error.message);
                }
            }
        })
        </script>
        <div class="settings">
            <div class="flex flex-col gap-4 items-stretch">
                <div data-settings-target="error" class="bg-red-200 p-2 rounded text-red-600 mb-2 text-sm empty:hidden"></div>
                <input
                    class="text-input"
                    type="text"
                    name="email"
                    data-settings-target="email"
                    placeholder="Email Address"
                    autocorrect="off"
                    autocapitalize="off"
                    spellcheck="false"
                    required
                />
                <input
                    class="text-input"
                    type="password"
                    name="password"
                    data-settings-target="password"
                    placeholder="Password"
                />
            </div>

            <span data-settings-target="results"></span>
        </div>
    {% endcapture %}
    {% capture button %}
        <button data-settings-target="submitButton" type="submit" class="primary-button">
            <span class="hidden group-data-[settings-loading-value=false]:block">
                Sign In
            </span>
            <span class="hidden group-data-[settings-loading-value=true]:block">
                Loadingâ€¦
            </span>
        </button>
    {% endcapture %}
    {% include shared/tab.html content=content button=button %}
</form>
