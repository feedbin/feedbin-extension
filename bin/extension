#!/bin/bash

set -e

case "$1" in
  setup)
    # Check for Ruby
    if ! command -v ruby &> /dev/null; then
      echo "Error: Ruby is not installed"
      exit 1
    fi

    # Check for Node
    if ! command -v node &> /dev/null; then
      echo "Error: Node is not installed"
      exit 1
    fi

    # Install dependencies
    bundle install
    npm install
    ;;

  test)
    bundle exec rake
    ;;

  run)
    bundle exec foreman start
    ;;

  build)
    JEKYLL_ENV=${JEKYLL_ENV:-"production"} bundle exec jekyll build
    ;;

  build_chrome)
    # Build the extension
    JEKYLL_ENV=${JEKYLL_ENV:-"production"} bundle exec jekyll build
    
    # Remove action.default_icon from manifest.json
    ruby -rjson -e '
      manifest_path = "_site/manifest.json"
      manifest = JSON.parse(File.read(manifest_path))
      manifest["action"]&.delete("default_icon")
      File.write(manifest_path, JSON.pretty_generate(manifest))
    '
    
    # Get version from manifest.json
    VERSION=$(ruby -rjson -e 'puts JSON.parse(File.read("_site/manifest.json"))["version"]')
    
    # Create zip file
    cd _site && zip -r "../chrome_${VERSION}.zip" . && cd ..
    echo "Created chrome_${VERSION}.zip"
    ;;

  *)
    echo "Usage: $0 {setup|test|run|build|build_chrome}"
    exit 1
    ;;
esac