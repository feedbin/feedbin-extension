#!/bin/bash

set -e

case "$1" in
  setup)
    # Check for Ruby
    if ! command -v ruby &> /dev/null; then
      echo "Error: Ruby is not installed"
      exit 1
    fi

    # Check for Node
    if ! command -v node &> /dev/null; then
      echo "Error: Node is not installed"
      exit 1
    fi

    # Install dependencies
    bundle install
    npm install
    ;;

  test)
    bundle exec rake
    ;;

  run)
    BUILD_TARGET=${BUILD_TARGET:-"firefox"} bundle exec foreman start
    ;;

  package_ios)
    BUILD_TARGET=${BROWSER:-"safari"} JEKYLL_ENV=${JEKYLL_ENV:-"production"} bundle exec jekyll build --destination _site/safari
    ;;

  package)
    # Parse version from manifest.yml
    VERSION=$(ruby -ryaml -e "puts YAML.load_file('manifest.yml', aliases: true)['defaults']['version']")

    # Build and package Chrome
    BUILD_TARGET=chrome JEKYLL_ENV=production bundle exec jekyll build --destination _site/chrome
    cd _site/chrome && zip -r ../../tmp/chrome_${VERSION}.zip . && cd ../..
    echo "Created chrome_${VERSION}.zip"

    # Build and package Firefox
    BUILD_TARGET=firefox JEKYLL_ENV=production bundle exec jekyll build --destination _site/firefox
    cd _site/firefox && zip -r ../../tmp/firefox_${VERSION}.zip . && cd ../..
    echo "Created firefox_${VERSION}.zip"
    ;;

  *)
    echo "Usage: $0 {setup|test|run|build|package}"
    exit 1
    ;;
esac